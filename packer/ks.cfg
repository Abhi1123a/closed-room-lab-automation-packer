#version=RHEL9
cdrom
graphical
reboot --eject

lang en_US.UTF-8
keyboard us
timezone America/New_York --utc

network --device=link --onboot=no --bootproto=dhcp 

selinux --enforcing
firewall --enabled --ssh

# -------------------------------------------------
# Bootloader (kdump + FIPS safe)
# -------------------------------------------------
bootloader --boot-drive=sda --append="audit=1 fips=1 ipv6.disable=1 vsyscall=none crashkernel=auto"

# -------------------------------------------------
# Disk Layout (Encrypted LVM)
# -------------------------------------------------
ignoredisk --only-use=sda
clearpart --all --initlabel

part /boot --fstype=xfs --size=1024
part pv.01 --size=1 --grow --encrypted

volgroup vg_secure pv.01
logvol /     --vgname=vg_secure --name=root --size=8192 --fstype=xfs
logvol /home --vgname=vg_secure --name=home --size=4096 --fstype=xfs
logvol swap  --vgname=vg_secure --name=swap --size=2048

# -------------------------------------------------
# Users
# -------------------------------------------------
rootpw --lock
user --name=ansible --groups=wheel --password=changeme --plaintext

# -------------------------------------------------
# Repositories (MUST be --install)
# -------------------------------------------------
repo --name="BaseOS"    --baseurl=file:///run/install/repo/BaseOS    --install
repo --name="AppStream" --baseurl=file:///run/install/repo/AppStream --install  # ADDED: Needed for ansible-core

# -------------------------------------------------
# Packages (Minimal + STIG-safe)
# -------------------------------------------------
%packages --ignoremissing --excludedocs
@^minimal-environment
@core
@system-tools

authselect
ansible-core
openssh-server
openssh-clients
pam
shadow-utils
bash
coreutils
chrony
sudo
vim
tmux
openssh-server
policycoreutils
audit
audit-libs
dracut
dracut-fips
kexec-tools
openscap-scanner      # ADDED: For OpenSCAP scans
scap-security-guide   # ADDED: Contains STIG content

# Explicitly forbid Samba/CIFS
-samba*
-cifs*
-libwbclient*
-sssd*
-sssd-kcm*
-realmd*
-oddjob*
%end

services --enabled=sshd

# -------------------------------------------------
# KDUMP (Enabled DURING install)
# -------------------------------------------------
%addon com_redhat_kdump --enable --reserve-mb='auto'
%end


%pre --log=/tmp/ks-pre.log

echo
echo "=============================================="
echo " Disk Encryption Setup"
echo " Please enter LUKS passphrase (8+ characters)"
echo "=============================================="
echo

stty -echo
read PASSPHRASE < /dev/tty
stty echo
echo

if [ ${#PASSPHRASE} -lt 8 ]; then
    echo "ERROR: Passphrase must be at least 8 characters"
    sleep 5
    exit 1
fi

echo "$PASSPHRASE" > /tmp/luks.pass
chmod 600 /tmp/luks.pass

%end

# -------------------------------------------------
# Post-install Hardening
# -------------------------------------------------
%post --log=/root/ks-post.log

authselect select minimal --force
# Enable FIPS (initramfs rebuild will occur)
fips-mode-setup --enable

# SSH hardening
sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^#Protocol.*/Protocol 2/' /etc/ssh/sshd_config
sed -i 's/^#MaxAuthTries.*/MaxAuthTries 3/' /etc/ssh/sshd_config
sed -i 's/^#LoginGraceTime.*/LoginGraceTime 30/' /etc/ssh/sshd_config
sed -i 's/^#X11Forwarding.*/X11Forwarding no/' /etc/ssh/sshd_config

mkdir -p /opt/ansible
chmod 755 /opt/ansible
dnf install -y ansible-core

# Disable IPv6 (kernel parameter already set above, this is redundant but harmless)
cat <<EOF >> /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
EOF

# Password aging (STIG-aligned)
sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS 60/' /etc/login.defs
sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS 1/' /etc/login.defs
sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE 7/' /etc/login.defs

# Enable auditing
systemctl enable auditd

# Lock Ctrl-Alt-Del
systemctl mask ctrl-alt-del.target

# Disable NetworkManager autostart (air-gapped)
systemctl disable NetworkManager

# STIG login banner
cat <<EOF > /etc/issue
Authorized use only. Activity may be monitored.
EOF

chmod 644 /etc/issue

# ADDED: Create directory for OpenSCAP results
mkdir -p /root/openscap
chmod 700 /root/openscap

%end